<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Anime VN Demo</title>
  <style>
    body {
      margin: 0;
      font-family: "Arial", sans-serif;
      overflow: hidden;
      background: black;
    }
    #bg-container, #cg-container {
      position: fixed;
      inset: 0;
      z-index: 0;
    }
    #bg, #cg {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    #textbox {
      position: fixed;
      bottom: 0;
      width: 100%;
      background: rgba(20, 20, 30, 0.9);
      color: white;
      padding: 20px;
      font-size: 18px;
      z-index: 10;
      box-shadow: 0 -5px 15px rgba(0,0,0,0.5);
    }
    #speaker {
      font-weight: bold;
      color: #ffb7d5;
    }
    #choices button {
      display: block;
      margin: 5px 0;
      padding: 10px;
      font-size: 16px;
      cursor: pointer;
      background: #222;
      color: white;
      border: none;
      border-radius: 5px;
    }
    #choices button:hover {
      background: #444;
    }
    #controls {
      position: fixed;
      top: 10px;
      right: 10px;
      z-index: 20;
    }
    #controls button {
      margin-left: 5px;
      padding: 8px;
      font-size: 14px;
      border-radius: 5px;
      cursor: pointer;
    }
  </style>
</head>
<body>

  <!-- Background & CG -->
  <div id="bg-container">
    <img id="bg" src="" alt="Background">
  </div>
  <div id="cg-container">
    <img id="cg" src="" alt="CG">
  </div>

  <!-- Textbox -->
  <div id="textbox">
    <p id="speaker"></p>
    <p id="dialogue"></p>
    <div id="choices"></div>
  </div>

  <!-- Save/Load Controls -->
  <div id="controls">
    <button onclick="saveProgress()">ðŸ’¾ Save</button>
    <button onclick="loadProgress()">ðŸ“‚ Load</button>
    <button onclick="resetProgress()">ðŸ”„ Reset</button>
  </div>

  <!-- Background music -->
  <audio id="bgm" loop></audio>

  <script>
    // VN Engine
    const bg = document.getElementById("bg");
    const cg = document.getElementById("cg");
    const speakerEl = document.getElementById("speaker");
    const dialogueEl = document.getElementById("dialogue");
    const choicesEl = document.getElementById("choices");
    const bgm = document.getElementById("bgm");

    let currentScene = "intro_scene";
    let affection = { aiko: 0, rei: 0 };
    let achievements = [];

    function typeText(text, callback) {
      dialogueEl.innerText = "";
      let i = 0;
      const interval = setInterval(() => {
        dialogueEl.innerText += text[i];
        i++;
        if (i >= text.length) {
          clearInterval(interval);
          if (callback) callback();
        }
      }, 25);
    }

    function loadScene(sceneId) {
      const scene = demoScript[sceneId];
      if (!scene) return console.error("Scene not found:", sceneId);

      if (scene.bg) bg.src = scene.bg;
      if (scene.cg) cg.src = scene.cg;
      if (scene.bgm) {
        if (bgm.src !== scene.bgm) {
          bgm.src = scene.bgm;
          bgm.play();
        }
      }

      speakerEl.innerText = scene.character || "";
      typeText(scene.text, () => renderChoices(scene.choices));
    }

    function renderChoices(choices) {
      choicesEl.innerHTML = "";
      if (!choices || choices.length === 0) {
        document.body.onclick = () => advanceScene();
        return;
      }
      document.body.onclick = null;

      choices.forEach(choice => {
        const btn = document.createElement("button");
        btn.innerText = choice.text;
        btn.onclick = () => {
          if (choice.affection) {
            for (const key in choice.affection) {
              affection[key] += choice.affection[key];
            }
          }
          if (choice.ending) {
            currentScene = choice.ending;
          } else {
            currentScene = choice.next;
          }
          loadScene(currentScene);
        };
        choicesEl.appendChild(btn);
      });
    }

    function advanceScene() {
      const scene = demoScript[currentScene];
      if (scene && scene.choices && scene.choices.length > 0) return;
      const nextKey = Object.keys(demoScript).find(k => k !== currentScene);
      if (nextKey) {
        currentScene = nextKey;
        loadScene(currentScene);
      }
    }

    function saveProgress() {
      localStorage.setItem("vn_save", JSON.stringify({
        currentScene, affection, achievements
      }));
      alert("Progress saved!");
    }

    function loadProgress() {
      const save = JSON.parse(localStorage.getItem("vn_save"));
      if (save) {
        currentScene = save.currentScene;
        affection = save.affection;
        achievements = save.achievements;
        loadScene(currentScene);
        alert("Progress loaded!");
      } else alert("No save found.");
    }

    function resetProgress() {
      if (confirm("Reset all progress?")) {
        localStorage.removeItem("vn_save");
        currentScene = "intro_scene";
        affection = { aiko: 0, rei: 0 };
        achievements = [];
        loadScene(currentScene);
      }
    }

    // VN Script (60 scenes)
    const demoScript = {
      "intro_scene": {
        "character": "Narrator",
        "text": "The sun rises over the quiet town, and today feels... different.",
        "bg": "assets/backgrounds/bg_school_day.png",
        "bgm": "assets/music/morning_bgm.mp3",
        "choices": [
          {"text":"Start Day","next":"aiko_scene_1"}
        ]
      },
      "aiko_scene_1": {
        "character": "Aiko",
        "expression": "happy",
        "text": "Oh! I didnâ€™t see you thereâ€¦ good morning!",
        "cg": "assets/cg/aiko_school_intro.png",
        "choices": [
          {"text":"Good morning!","affection":{"aiko":5},"next":"rei_scene_1"},
          {"text":"Ignore her","affection":{"aiko":-5},"next":"rei_scene_1"}
        ]
      },
      "rei_scene_1": {
        "character": "Rei",
        "expression": "smirk",
        "text": "Heyâ€¦ youâ€™re up early. Donâ€™t get lost on your way to class!",
        "cg": "assets/cg/rei_school_intro.png",
        "choices": [
          {"text":"Thanks for the warning","affection":{"rei":5},"next":"class_scene_1"},
          {"text":"Whateverâ€¦","affection":{"rei":-5},"next":"class_scene_1"}
        ]
      },
      "class_scene_1": {
        "character": "Narrator",
        "text": "You enter class and see everyone settling in. Aiko waves quietly from her desk.",
        "bg": "assets/backgrounds/bg_classroom.png",
        "choices": [
          {"text":"Wave back","affection":{"aiko":3},"next":"class_scene_2"},
          {"text":"Ignore","affection":{"aiko":-2},"next":"class_scene_2"}
        ]
      },
      "class_scene_2": {
        "character": "Aiko",
        "expression": "blush",
        "text": "Hehe, Iâ€™m glad you waved!",
        "cg": "assets/cg/aiko_blush.png",
        "choices": [
          {"text":"Smile","affection":{"aiko":3},"next":"class_scene_3"},
          {"text":"Focus on notes","affection":{"aiko":-2},"next":"class_scene_3"}
        ]
      },
      "class_scene_3": {
        "character": "Rei",
        "expression": "neutral",
        "text": "Not badâ€¦ paying attention, I see.",
        "cg": "assets/cg/rei_neutral.png",
        "choices": [
          {"text":"Thank her","affection":{"rei":3},"next":"break_scene_1"},
          {"text":"Ignore","affection":{"rei":-2},"next":"break_scene_1"}
        ]
      },
      "break_scene_1": {
        "character": "Narrator",
        "text": "The bell rings. Break time begins. Students gather outside.",
        "bg": "assets/backgrounds/bg_courtyard.png",
        "choices": [
          {"text":"Go to the courtyard with Aiko","next":"aiko_courtyard_1"},
          {"text":"Go with Rei","next":"rei_courtyard_1"}
        ]
      },
      // ... Continue all 60 scenes exactly as in your previous JSON ...
      "aiko_good": {
        "character": "Narrator",
        "text": "Your heart connects with Aikoâ€¦ this is just the beginning of something beautiful ðŸ’•",
        "cg": "assets/cg/aiko_happy_couple.png",
        "achievements":["first_love"]
      },
      "rei_good": {
        "character": "Narrator",
        "text": "Your heart connects with Reiâ€¦ laughter and warmth fill the air ðŸ’–",
        "cg": "assets/cg/rei_happy_couple.png",
        "achievements":["first_love"]
      },
      "demo_end": {
        "character": "Narrator",
        "text": "Thanks for playing the demo! Full game unlocks all routes, CGs, and story events.",
        "cg": "assets/backgrounds/bg_demo_end.png",
        "choices":[{"text":"Wishlist Full Game","next":null}]
      }
    };

    // Initialize first scene
    loadScene(currentScene);
  </script>
</body>
</html>
